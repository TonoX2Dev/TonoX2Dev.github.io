<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ฝากไฟล์ปริ้น - TonoX2Shop</title>
<link rel="icon" href="images/favicon.png" />
<!-- ฟอนต์ Kanit จาก Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
<style>
  /* ฟอนต์และพื้นฐาน */
  body, input, select, button, textarea, label {
    font-family: 'Kanit', sans-serif;
  }
  body {
    margin: 0; padding: 0;
    background: linear-gradient(270deg, #3a0ca3, #720026, #3a0ca3);
    background-size: 600% 600%;
    animation: bgmove 15s ease infinite;
    color: #eee;
  }
  @keyframes bgmove {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  /* เมนูบนซ้าย */
  #menu-home {
    position: fixed;
    top: 15px; left: 15px;
    background: rgba(255 255 255 / 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    display: flex; align-items: center;
    gap: 6px;
    transition: background-color 0.3s;
  }
  #menu-home:hover {
    background: rgba(255 255 255 / 0.25);
  }
  #menu-home img {
    width: 24px; height: 24px;
  }
  #menu-home span {
    font-weight: 600;
    color: #eee;
  }

  /* ส่วนหัวรูปเครื่องปริ้น */
  header {
    width: 100%;
    height: 180px;
    background: url('images/free_Code.jpg') center center/cover no-repeat;
    filter: drop-shadow(0 0 8px rgba(255 255 255 0.2));
    box-shadow: inset 0 0 30px rgba(255 255 255, 0.15);
  }

  /* ฟอร์ม */
  main {
    max-width: 600px;
    background: rgba(0,0,0,0.5);
    margin: 20px auto 50px;
    padding: 30px 25px;
    border-radius: 15px;
    box-shadow: 0 0 25px #5b3db2aa;
  }

  h1 {
    text-align: center;
    margin-bottom: 30px;
    color: #f0e8ff;
    text-shadow: 1px 1px 4px #35004fbb;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
  }

  input[type="text"], select, textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1.5px solid #555;
    background: #1a1425;
    color: #eee;
    font-size: 16px;
    box-sizing: border-box;
    margin-bottom: 18px;
    transition: border-color 0.3s;
  }
  input[type="text"]:focus, select:focus, textarea:focus {
    border-color: #7e57c2;
    outline: none;
  }
  input::placeholder, textarea::placeholder {
    font-family: 'Kanit', sans-serif;
    color: #aaa;
  }

  /* กล่องอัปโหลดไฟล์ใหญ่ รองรับลากไฟล์ */
  #file-upload-container {
    border: 2px dashed #8e7cc3;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    color: #ccc;
    font-weight: 600;
    margin-bottom: 12px;
    cursor: pointer;
    transition: background-color 0.3s, border-color 0.3s;
    user-select: none;
    position: relative;
  }
  #file-upload-container.dragover {
    background-color: #6c4ab6cc;
    border-color: #d1c4e9;
    color: white;
  }
  #file-upload {
    display: none;
  }

  /* แสดงชื่อไฟล์ที่เลือก */
  #file-list {
    margin-top: 8px;
    color: #eee;
    font-size: 14px;
    text-align: left;
    max-height: 90px;
    overflow-y: auto;
  }

  /* แถวเลือกจำนวนแผ่นและชุด */
  .inline-row {
    display: flex;
    gap: 15px;
    margin-bottom: 18px;
  }
  .inline-row > div {
    flex: 1;
  }

  /* ช่องเตือนสีแดง */
  .error-message {
    color: #ff6b6b;
    font-size: 13px;
    margin-top: -12px;
    margin-bottom: 14px;
    font-weight: 600;
  }

  /* ราคาใต้เลือกหมึก */
  #price-info {
    color: #ddd;
    font-size: 13px;
    margin-top: -10px;
    margin-bottom: 18px;
    font-weight: 500;
    text-align: center;
    user-select: none;
  }

  /* Checkbox และข้อความให้อยู่บรรทัดเดียว */
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 25px;
    color: #eee;
    font-weight: 600;
    user-select: none;
  }
  .checkbox-group input[type="checkbox"] {
    margin-left: 0;
    margin-right: 4px;
    transform: scale(1.25);
    cursor: pointer;
  }

  /* ปุ่มส่ง */
  button[type="submit"] {
    width: 100%;
    padding: 14px;
    background: linear-gradient(45deg, #7e57c2, #4527a0);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 0 15px #7e57c2cc;
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  button[type="submit"]:hover {
    background: linear-gradient(45deg, #5e35b1, #311b92);
    box-shadow: 0 0 25px #5e35b1dd;
  }

 #submitBtn {
    position: relative;
    background: #6a5acd;
    border: none;
    color: white;
    padding: 12px 0;
    width: 100%;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 700;
   
  }
  #submitBtn:hover {
    background: #5849c2;
  }
  /* ไอคอนหมุน */
  .spinner {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    width: 24px;
    height: 24px;
    margin: -12px 0 0 -12px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

/* ปรับ number input ให้เหมือน text input */
input[type="number"] {
  -webkit-appearance: none;
  -moz-appearance: textfield;
  appearance: none;
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.5px solid #555;
  background: #1a1425;
  color: #eee;
  font-size: 16px;
  box-sizing: border-box;
  margin-bottom: 18px;
  transition: border-color 0.3s;
}
input[type="number"]:focus {
  border-color: #7e57c2;
  outline: none;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>
<body>

<!-- เมนูบ้านบนซ้าย -->
<div id="menu-home" onclick="location.href='index.html'">
  <img src="images/home_icon.png" alt="Home" />
  <span>หน้าหลัก</span>
</div>

<header></header>

<main>
  <h1>รับปริ้นงานออนไลน์</h1>

  <form id="printer-form" action="https://getform.io/f/bpjpzvyb" method="POST" enctype="multipart/form-data" target="hidden_iframe" onsubmit="return onFormSubmit()" novalidate>

    <!-- Hidden field for redirect after submission -->


    <label for="fullname">ชื่อจริงเฟสบุ๊ค หรือลิงค์ profile*</label>
    <input type="text" id="fullname" name="fullname" placeholder="ลิงค์ profile เช่น https://www.facebook.com/your.name" required />
    <div class="error-message" id="error-fullname"></div>

    <label for="file-upload-container">แนบไฟล์ (PDF, PNG, JPG, JPEG, DOCX) *<br><small>ลากหรือคลิกเพื่อเลือกไฟล์ได้หลายไฟล์</small></label>
    <div id="file-upload-container">
      <input type="file" id="file-upload" name="files[]" accept=".pdf,.png,.jpg,.jpeg,.docx" multiple required />
      <div id="file-list">ยังไม่มีไฟล์ถูกเลือก</div>
    </div>
    <div class="error-message" id="error-files"></div>
    
    <div class="inline-row">
      <div>
        <label for="pages">จำนวนแผ่น:</label>
      <input type="number" id="pages" name="pages" min="1" placeholder="จำนวนแผ่น" required>

        <div class="error-message" id="error-pages"></div>
      </div>
      <div>
        <label for="sets">จำนวนชุด *</label>
        <input type="number" id="sets" name="sets" min="1" value="1" required />
        <div class="error-message" id="error-sets"></div>
      </div>
    </div>

    <label for="color-type">ประเภทการพิมพ์ *</label>
    <select id="color-type" name="color_type" required>
      <option value="">-- กรุณาเลือก --</option>
      <option value="black">ขาวดำ (5 บาท/แผ่น)</option>
      <option value="color">สี (10 บาท/แผ่น)</option>
    </select>
    <div id="price-info">ราคา: ขาวดำ 5 บาท/แผ่น, สี 10 บาท/แผ่น</div>
    <div class="error-message" id="error-color-type"></div>

    <div class="checkbox-group">
      <input type="checkbox" id="agree" name="agree" required />
      <label for="agree">ฉันยินยอมข้อมูลเเละชำระเงินตอนนี้</label>
    </div>
    <div class="error-message" id="error-agree"></div>

    <div>
      <label>รวมราคา</label>
      <input type="text" id="total-price" name="total_price" readonly style="background:#2a1f4d; color:#eee; font-weight: 700; text-align:center;" value="0 บาท" />
    </div>

    <br />
    <button type="submit" id="submitBtn">
  <div class="spinner" id="spinner"></div>
  <span id="submitText">ส่งคำขอปริ้น</span>
</button>

    
    <iframe name="hidden_iframe" style="display: none;" onload="formSubmitted()"></iframe>

  </form>
</main>

<script>
  const form = document.getElementById('printer-form');
  const fileUploadContainer = document.getElementById('file-upload-container');
  const fileInput = document.getElementById('file-upload');
  const fileList = document.getElementById('file-list');
  const pagesInput = document.getElementById('pages');
  const setsInput = document.getElementById('sets');
  const colorSelect = document.getElementById('color-type');
  const totalPriceInput = document.getElementById('total-price');

  // Error message elements
  const errors = {
    fullname: document.getElementById('error-fullname'),
    files: document.getElementById('error-files'),
    pages: document.getElementById('error-pages'),
    sets: document.getElementById('error-sets'),
    colorType: document.getElementById('error-color-type'),
    agree: document.getElementById('error-agree'),
  };

  // แสดงชื่อไฟล์ในกล่อง
  function updateFileList() {
    if (fileInput.files.length === 0) {
      fileList.textContent = "ยังไม่มีไฟล์ถูกเลือก";
    } else {
      const names = Array.from(fileInput.files).map(f => f.name);
      fileList.textContent = names.join(", ");
      // อัปเดตจำนวนแผ่นอัตโนมัติเป็นไฟล์ที่เลือกได้เลย (ถ้าต้องการ)
      // หรือให้กรอกเองในช่อง pages (ตอนนี้ไม่ได้เปลี่ยนอัตโนมัติ)
    }
  }

  // รองรับลากไฟล์มาวาง
  fileUploadContainer.addEventListener('click', () => fileInput.click());
  fileUploadContainer.addEventListener('dragover', e => {
    e.preventDefault();
    fileUploadContainer.classList.add('dragover');
  });
  fileUploadContainer.addEventListener('dragleave', e => {
    e.preventDefault();
    fileUploadContainer.classList.remove('dragover');
  });
  fileUploadContainer.addEventListener('drop', e => {
    e.preventDefault();
    fileUploadContainer.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      updateFileList();
    }
  });

  fileInput.addEventListener('change', updateFileList);

  // คำนวณราคา
  function calculatePrice() {
    const pages = parseInt(pagesInput.value);
    const sets = parseInt(setsInput.value);
    const colorType = colorSelect.value;
    if (isNaN(pages) || pages < 1 || isNaN(sets) || sets < 1 || !colorType) {
      totalPriceInput.value = "0 บาท";
      return;
    }
    let pricePerPage = colorType === 'color' ? 10 : 5;
    let total = pages * sets * pricePerPage;
    totalPriceInput.value = total.toLocaleString('th-TH') + " บาท";
  }

  pagesInput.addEventListener('input', calculatePrice);
  setsInput.addEventListener('input', calculatePrice);
  colorSelect.addEventListener('change', calculatePrice);

  // ฟังก์ชันตรวจสอบฟอร์มก่อนส่ง
  form.addEventListener('submit', e => {
    let valid = true;

    // เคลียร์ข้อความ error ก่อน
    for (const key in errors) {
      errors[key].textContent = '';
    }

    // เช็คชื่อ-นามสกุล
    if (!form.fullname.value.trim()) {
      errors.fullname.textContent = "โปรดกรอกชื่อ-ลิงค์เฟสบุ๊คในถูกต้อง";
      valid = false;
    }
    // เช็คไฟล์
    if (!fileInput.files.length) {
      errors.files.textContent = "โปรดแนบไฟล์อย่างน้อย 1 ไฟล์";
      valid = false;
    }
    // เช็คจำนวนแผ่น
    if (!form.pages.value || parseInt(form.pages.value) < 1) {
      errors.pages.textContent = "โปรดกรอกจำนวนแผ่นอย่างถูกต้อง";
      valid = false;
    }
    // เช็คจำนวนชุด
    if (!form.sets.value || parseInt(form.sets.value) < 1) {
      errors.sets.textContent = "โปรดกรอกจำนวนชุดอย่างถูกต้อง";
      valid = false;
    }
    // เช็คประเภทการพิมพ์
    if (!form.color_type.value) {
      errors.colorType.textContent = "โปรดเลือกประเภทการพิมพ์";
      valid = false;
    }
    // เช็ค checkbox ยินยอม
    if (!form.agree.checked) {
      errors.agree.textContent = "คุณต้องยืนยันความยินยอมก่อนส่ง";
      valid = false;
    }

    if (!valid) {
      e.preventDefault();
      // เลื่อนขึ้นบนเพื่อให้เห็น error
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  
  let submitting = false;
  function onFormSubmit() {
    submitting = true;
    return true; // ให้ฟอร์ม submit ตามปกติ
  }

  function formSubmitted() {
    if (submitting) {
      submitting = false;
      setTimeout(() => {
        window.location.href = "thank_you.html";
      }, 200); // รอโหลดเสร็จสักนิด แล้วค่อย redirect
    }
  }

  // ... โค้ดเดิมด้านบนไม่ต้องเปลี่ยน ...

  fileInput.addEventListener('change', () => {
    updateFileList();
    detectPagesFromFiles(fileInput.files);
  });

  // ตรวจแผ่นอัตโนมัติจากไฟล์
  function detectPagesFromFiles(files) {
    let totalPages = 0;
    let processed = 0;

    [...files].forEach(file => {
      const ext = file.name.split('.').pop().toLowerCase();

      if (ext === 'pdf') {
        const reader = new FileReader();
        reader.onload = function() {
          const typedArray = new Uint8Array(reader.result);
          pdfjsLib.getDocument(typedArray).promise.then(doc => {
            totalPages += doc.numPages;
            processed++;
            checkAndSetPages();
          }).catch(() => processed++);
        };
        reader.readAsArrayBuffer(file);

      } else if (ext === 'docx') {
        const reader = new FileReader();
        reader.onload = function() {
          mammoth.convertToHtml({ arrayBuffer: reader.result })
            .then(() => {
              // สมมุติว่า docx เฉลี่ย 1 หน้า ต่อทุก ~600 คำ (ประมาณคร่าว ๆ)
              const wordCount = reader.result.byteLength / 6; // ประมาณคำ
              const estimatedPages = Math.max(1, Math.round(wordCount / 300)); 
              totalPages += estimatedPages;
              processed++;
              checkAndSetPages();
            }).catch(() => processed++);
        };
        reader.readAsArrayBuffer(file);

      } else {
        processed++;
        checkAndSetPages();
      }
    });

    function checkAndSetPages() {
      if (processed === files.length) {
        if (totalPages > 0) {
          pagesInput.value = totalPages;
          calculatePrice(); // อัปเดตราคา
        }
      }
    }
  }

  // ปุ่ม submit - แสดงรูปโหลด
  form.addEventListener('submit', e => {
    const spinner = document.getElementById('spinner');
    spinner.style.display = 'block';
    document.getElementById('submitBtn').disabled = true;
  });

  form.addEventListener('submit', e => {
  let valid = true;

  // เคลียร์ข้อความ error ก่อน
  for (const key in errors) {
    errors[key].textContent = '';
  }

  // Validation (เหมือนเดิม)
  if (!form.fullname.value.trim()) {
    errors.fullname.textContent = "โปรดกรอกชื่อ-ลิงค์เฟสบุ๊คในถูกต้อง";
    valid = false;
  }
  if (!fileInput.files.length) {
    errors.files.textContent = "โปรดแนบไฟล์อย่างน้อย 1 ไฟล์";
    valid = false;
  }
  if (!form.pages.value || parseInt(form.pages.value) < 1) {
    errors.pages.textContent = "โปรดกรอกจำนวนแผ่นอย่างถูกต้อง";
    valid = false;
  }
  if (!form.sets.value || parseInt(form.sets.value) < 1) {
    errors.sets.textContent = "โปรดกรอกจำนวนชุดอย่างถูกต้อง";
    valid = false;
  }
  if (!form.color_type.value) {
    errors.colorType.textContent = "โปรดเลือกประเภทการพิมพ์";
    valid = false;
  }
  if (!form.agree.checked) {
    errors.agree.textContent = "คุณต้องยืนยันความยินยอมก่อนส่ง";
    valid = false;
  }

  if (!valid) {
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    // ซ่อน spinner, แสดงข้อความ submit
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('submitText').style.display = 'inline';
    document.getElementById('submitBtn').disabled = false;
    return;
  }

  // ถ้าผ่าน validation
  document.getElementById('spinner').style.display = 'block';
  document.getElementById('submitText').style.display = 'none';
  document.getElementById('submitBtn').disabled = true;
});
</script>
</body>
</html>
